{% extends 'base.html' %}
{% load static %}

{% block title %}Live Tracking - ROREM{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row g-0">
        <!-- Live Tracking Map -->
        <div class="col-lg-8">
            <div class="position-relative" style="height: 100vh;">
                <div id="trackingMap" style="height: 100vh; width: 100%;"></div>
                
                <!-- Tracking Controls -->
                <div class="position-absolute top-0 start-0 m-3">
                    <div class="card shadow">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-3" style="color: #1e3a8a;">
                                <i class="fas fa-satellite-dish me-2"></i>Live Tracking
                            </h6>
                            
                            <!-- ETA Display -->
                            <div class="text-center mb-3">
                                <div class="display-6 fw-bold text-primary" id="etaDisplay">--</div>
                                <small class="text-muted">Estimated Arrival</small>
                            </div>
                            
                            <!-- Distance -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Distance:</span>
                                <strong id="distanceDisplay">-- km</strong>
                            </div>
                            
                            <!-- Provider Info -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Provider:</span>
                                <strong>{{ assistance_request.accepted_provider.company_name }}</strong>
                            </div>
                            
                            <!-- Status -->
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Status:</span>
                                <span class="badge" id="statusBadge">
                                    {{ assistance_request.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="position-absolute bottom-0 start-0 m-3">
                    <div class="btn-group shadow">
                        <button class="btn btn-light" id="callProvider">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-light" id="messageProvider">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="btn btn-light" id="shareLocation">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Demo Control (for testing) -->
                {% if user.is_staff %}
                <div class="position-absolute bottom-0 end-0 m-3">
                    <div class="card shadow">
                        <div class="card-body p-2">
                            <small class="text-muted d-block mb-1">Demo Controls</small>
                            <button class="btn btn-warning btn-sm" id="simulateMovement">
                                <i class="fas fa-play me-1"></i>Simulate Movement
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Tracking Details Sidebar -->
        <div class="col-lg-4">
            <div class="h-100 bg-light p-3" style="overflow-y: auto;">
                <!-- Request Details -->
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h6 class="card-title mb-0" style="color: #1e3a8a;">
                            <i class="fas fa-info-circle me-2"></i>Request Details
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 small">
                            <div class="col-6">
                                <strong>Service:</strong><br>
                                <span class="text-muted">{{ assistance_request.get_service_type_display }}</span>
                            </div>
                            <div class="col-6">
                                <strong>Request ID:</strong><br>
                                <span class="text-muted">#{{ assistance_request.id }}</span>
                            </div>
                            <div class="col-6">
                                <strong>Vehicle:</strong><br>
                                <span class="text-muted">{{ assistance_request.driver.vehicle_type }}</span>
                            </div>
                            <div class="col-6">
                                <strong>Plate:</strong><br>
                                <span class="text-muted">{{ assistance_request.driver.license_plate }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Provider Information -->
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h6 class="card-title mb-0" style="color: #1e3a8a;">
                            <i class="fas fa-user-hard-hat me-2"></i>Service Provider
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-start mb-3">
                            <div class="provider-avatar me-3">
                                <div class="service-icon {{ assistance_request.service_type }}">
                                    <i class="fas {{ assistance_request.service_type|default:'fa-store' }}"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ assistance_request.accepted_provider.company_name }}</h6>
                                <p class="text-muted mb-1 small">
                                    {{ assistance_request.accepted_provider.get_service_type_display }}
                                </p>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-warning text-dark me-2">
                                        ‚≠ê {{ assistance_request.accepted_provider.rating|default:"4.5" }}
                                    </span>
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Verified
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 small">
                            <div class="col-12">
                                <i class="fas fa-phone text-muted me-2"></i>
                                <span>{{ assistance_request.accepted_provider.phone }}</span>
                            </div>
                            <div class="col-12">
                                <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                <span class="text-muted">{{ assistance_request.accepted_provider.address|truncatewords:5 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Live Updates -->
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0" style="color: #1e3a8a;">
                            <i class="fas fa-clock me-2"></i>Live Updates
                        </h6>
                        <span class="badge bg-primary" id="updateCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="liveUpdates" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="small text-muted mt-2 mb-0">Starting live tracking...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Actions -->
                <div class="card mt-4 border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h6 class="card-title mb-0 text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>Emergency Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-danger btn-sm w-100">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-warning btn-sm w-100">
                                    <i class="fas fa-shield-alt me-1"></i>SOS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Global variables
    let trackingMap;
    let userMarker;
    let providerMarker;
    let routeLine;
    let trackingInterval;
    const trackingId = '{{ assistance_request.tracking_id }}';
    
    // Initialize tracking map
    function initTrackingMap() {
        // Create map
        trackingMap = L.map('trackingMap').setView([{{ assistance_request.latitude }}, {{ assistance_request.longitude }}], 13);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(trackingMap);
        
        // Add user marker (destination)
        userMarker = L.marker([{{ assistance_request.latitude }}, {{ assistance_request.longitude }}])
            .addTo(trackingMap)
            .bindPopup('<b>Your Location</b><br>Waiting for help to arrive.')
            .openPopup();
        
        // Custom icon for user
        userMarker.setIcon(L.divIcon({
            className: 'user-marker-tracking',
            html: '<div class="user-location-pulse"><i class="fas fa-user"></i></div>',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        }));
        
        // Start tracking updates
        startTrackingUpdates();
    }
    
    // Start periodic tracking updates
    function startTrackingUpdates() {
        // Get initial update
        updateTracking();
        
        // Set up periodic updates (every 5 seconds)
        trackingInterval = setInterval(updateTracking, 5000);
    }
    
    // Update tracking information
    function updateTracking() {
        fetch(`/maps/api/tracking-updates/${trackingId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTrackingDisplay(data);
                    
                    if (data.provider_location) {
                        updateProviderMarker(data.provider_location);
                        updateRouteLine(data.location_history);
                    }
                }
            })
            .catch(error => {
                console.error('Tracking update error:', error);
            });
    }
    
    // Update tracking information display
    function updateTrackingDisplay(data) {
        // Update ETA
        if (data.eta) {
            document.getElementById('etaDisplay').textContent = `${data.eta}m`;
        }
        
        // Update distance
        if (data.distance) {
            document.getElementById('distanceDisplay').textContent = `${data.distance} km`;
        }
        
        // Update status
        document.getElementById('statusBadge').textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1).replace('_', ' ');
        updateStatusBadge(data.status);
        
        // Add live update
        addLiveUpdate(data);
    }
    
    // Update provider marker on map
    function updateProviderMarker(providerLocation) {
        const providerLatLng = [providerLocation.lat, providerLocation.lon];
        
        if (providerMarker) {
            // Update existing marker
            providerMarker.setLatLng(providerLatLng);
        } else {
            // Create new marker
            providerMarker = L.marker(providerLatLng)
                .addTo(trackingMap)
                .bindPopup('<b>Service Provider</b><br>Help is on the way!');
            
            // Custom icon for provider
            providerMarker.setIcon(L.divIcon({
                className: 'provider-marker-tracking',
                html: '<div class="provider-location-moving"><i class="fas fa-truck"></i></div>',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            }));
        }
        
        // Fit map to show both markers
        if (userMarker && providerMarker) {
            const group = new L.featureGroup([userMarker, providerMarker]);
            trackingMap.fitBounds(group.getBounds().pad(0.1));
        }
    }
    
    // Update route line on map
    function updateRouteLine(locationHistory) {
        if (locationHistory && locationHistory.length > 1) {
            const routeCoordinates = locationHistory.map(loc => [loc.lat, loc.lon]);
            
            if (routeLine) {
                trackingMap.removeLayer(routeLine);
            }
            
            routeLine = L.polyline(routeCoordinates, {
                color: '#1e40af',
                weight: 4,
                opacity: 0.7,
                dashArray: '5, 10'
            }).addTo(trackingMap);
        }
    }
    
    // Add live update to sidebar
    function addLiveUpdate(data) {
        const updatesContainer = document.getElementById('liveUpdates');
        const updateCount = document.getElementById('updateCount');
        
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        
        let updateText = '';
        if (data.provider_location) {
            updateText = `Provider location updated - ${data.distance}km away`;
        } else {
            updateText = 'Waiting for provider location...';
        }
        
        const updateElement = document.createElement('div');
        updateElement.className = 'border-start border-3 border-primary ps-2 mb-2';
        updateElement.innerHTML = `
            <div class="small">
                <strong>${timeString}</strong>
                <p class="mb-0 text-muted">${updateText}</p>
            </div>
        `;
        
        // Add to top of list
        updatesContainer.insertBefore(updateElement, updatesContainer.firstChild);
        
        // Limit to 10 updates
        if (updatesContainer.children.length > 10) {
            updatesContainer.removeChild(updatesContainer.lastChild);
        }
        
        // Update count
        updateCount.textContent = updatesContainer.children.length;
    }
    
    // Update status badge color
    function updateStatusBadge(status) {
        const badge = document.getElementById('statusBadge');
        badge.className = 'badge';
        
        switch(status) {
            case 'accepted':
                badge.classList.add('bg-primary');
                break;
            case 'in_progress':
                badge.classList.add('bg-warning', 'text-dark');
                break;
            case 'completed':
                badge.classList.add('bg-success');
                break;
            default:
                badge.classList.add('bg-secondary');
        }
    }
    
    // Simulate provider movement (for demo)
    document.getElementById('simulateMovement')?.addEventListener('click', function() {
        fetch(`/maps/api/simulate-movement/${trackingId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTracking(); // Refresh display
                }
            });
    });
    
    // Action buttons
    document.getElementById('callProvider').addEventListener('click', function() {
        alert('Calling provider: {{ assistance_request.accepted_provider.phone }}');
    });
    
    document.getElementById('messageProvider').addEventListener('click', function() {
        alert('Opening chat with provider...');
    });
    
    document.getElementById('shareLocation').addEventListener('click', function() {
        if (navigator.share) {
            navigator.share({
                title: 'My Location',
                text: 'I need roadside assistance at this location',
                url: window.location.href
            });
        } else {
            alert('Location sharing not supported in this browser');
        }
    });
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initTrackingMap);
</script>

<style>
    /* Tracking-specific marker styles */
    .user-marker-tracking {
        background: none;
        border: none;
    }
    
    .user-location-pulse {
        width: 40px;
        height: 40px;
        background: #1e40af;
        border: 3px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(30, 64, 175, 0.5);
        animation: pulse 2s infinite;
    }
    
    .provider-marker-tracking {
        background: none;
        border: none;
    }
    
    .provider-location-moving {
        width: 40px;
        height: 40px;
        background: #10b981;
        border: 3px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(16, 185, 129, 0.5);
        animation: bounce 1s infinite alternate;
    }
    
    /* Animations */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(30, 64, 175, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(30, 64, 175, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(30, 64, 175, 0);
        }
    }
    
    @keyframes bounce {
        from {
            transform: translateY(0px);
        }
        to {
            transform: translateY(-5px);
        }
    }
    
    /* Live updates scrollbar */
    #liveUpdates::-webkit-scrollbar {
        width: 4px;
    }
    
    #liveUpdates::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    #liveUpdates::-webkit-scrollbar-thumb {
        background: #1e40af;
        border-radius: 2px;
    }
</style>
{% endblock %}
